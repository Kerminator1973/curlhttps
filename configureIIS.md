# Настройка IIS для поддержки клиентских сертификатов

Для обеспечения полноценного использования https может потребоваться сгенерировать самозаверенный сертификат:

![alt text](./CreateSelfSignedCertInIIS.png "Generate a self-signed certificate")

В качестве альтернативы может быть использована утилита dev-cert, из состава Microsoft.NET Core:

``` shell
dotnet dev-cert https --trust
```

Далее следует создать web-сайт в IIS для которого в привязках установливается сгенерированный самозаверенный сертификат.

С помощью утилиты mmc из этого сертификата генерируется файл «cer» и добавляется в раздел «Доверенные корневые центры сертификации».

Для возможности отладки web-приложения в Visual Studio, в IDE следует добавлить профиль отладки «запуск в IIS». При запуске приложения на отладку, осуществляется подключение к web-сайту и публикация актуальной версии приложения. При запуске проекта Visual Studio переназначает папку web-сайта на папку проекта (именно по этой причине, Visual Studio должен быть запущен из под учётной записи администратора).

В настройках сайта в IIS, в разделе "проверка подлинности" в web-приложении IIS следует выключить все проверки подлинности (они не нужны, т.к. аутентификацию планируется осуществлять проверяя клиентский сертификат).

Сгенерированный инфраструктурой PKI клиентский сертификат может быть добавить для текущего пользователя в локальное хранилище сертификатов. Это позволит использовать подключение к серверу и браузеров Chrome и Edge.

В параметрах web-сайта «Параметры SSL» следует установить галку «Требовать SSL» и выбрать «Требовать – сертификат клиента».

В оснастке для работы с сертификатами (mmc, оснастка "Сертификаты") сертификат сгенерированный PKI (.pfx) следует экспортировать в pem, затем из pem должно быть извлечено тело сертификата (находится между BEGIN CERTIFICATE и END CERTIFICATE). Извлечённое тело нужно привести в одну строку и добавить в редакторе конфигураций в IIS в раздел «system.webServer/security/authentication/iisClientCertificateMappingAuthentication»:

![alt text](./ConfigurationEditor.png "The Configuration Editor")

Объединить строки сертификата в одну строку можно используя Notepad++. Следует вызвать окно "Поиск -> Замена... (Ctrl+H)" и ввести шаблон замены "\r\n".

Извлечённое тело сертификата нужно добавить в «oneToOneMappings»:

![alt text](./oneToOneMapping.png "oneToOneMapping")

Внимание! Необходимо указывать userName и password. Эти параметры ассоциируются с пользователем операционной системы сертификат которого был предъявлен. Запуск пользовательской сессии выполняется под учётной записью этого пользователя.

Также может быть добавлен раздел "Rules", в котором указываются дополнительные параметры для проверки клиентского сертификата: Subject, Issuer, и т.д.

**Тестовая проверка**: запускаем браузер Edge/Chrome и пытаемся перейти на локальный web-сайт: https://ws-07654.dpr.msk.shq:8081/weatherforecast

Браузер отображает список доступных клиентских сертификатов в хранилище, состоящий из одного сертификата «Admin». Если его выбрать и ввести логин/пароль пользователя, то запрос проходит через IIS, динамически генерируется контент и отображается в браузере.

Тоже самое происходит и с Postman, но для этого случая нужно указать клиентский сертификат в «Settings -> Certificates»  (общие настройки Postman) для конкретного web-сайта.

![alt text](./PostmanLog.png "Postman Log")

**Ключевое замечание**: Если не указывать клиентский сертификат, или не ввести логин/пароль, то будет получен Http Status Code – 403.7 (Forbidden).

**UPDATE 2022**: Компания [LeaderSSL](https://www.instantssl.su/) выпускает сертификаты Sectigo/Comodo для пользователей из России за рубли. Можно выпустить сертификат на испытательный срок на 5-12 дней. Для задач КБ ДОРС (взаимная аутентификация клиента и сервера) мы использовали клиентский сертификат для проверки e-mail - он был встроен в BVSUpdate.

![alt text](./LeaderSSL.png "Personal Authentication")

**UPDATE 2023**: при развертывании web-приложения на промышленном сервере (который находится в публичном сегменте интернета), необходимо обеспечить доступа с сервера к удостоверяющему центру для проверки, не попал ли клиентский сертификат в _Certificate Revocation List_ (CRL). Если такого доступа не будет, IIS посчитает клиентский сертфикат не доверенным и заблокирует доступ к сайту.

Также следует заметить, что если на странице «Параметры SSL -> Сертификаты клиента» установить флаг со значения «Принимать» на «Требовать», то попытка доступа к странице не требующей предъявления сертификата (обычно, это некоторая тестовая страница) перестаёт быть доступной (мы получаем Http Status Code **403 Forbidden**).
